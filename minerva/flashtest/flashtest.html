<!doctype html>
<html>
<head>
	<meta http-equiv="charset" content="text/html; charset=utf-8">
	<title></title>
	<style>
		{{ getTestPageCSS() }}

		#controls tr td {
			padding: 0.5em 0 0.5em 0;
		}
	</style>
	<script>
		{{ expandScript('// import cw.autoTitle') }}
		window.CLOSURE_NO_DEPS = true;
		window.CSRF_TOKEN = {{ dumps(token) }};
	</script>
</head>
<body>

<div id="doc">
</div>

<table id="controls">
<tr>
	<td>Reconnect:</td>
	<td>
		<input type="submit" value="Disconnect and connect new transport" onclick="reconnect();return false">
	</td>
</tr>
<tr>
<td>
	Send ACK:
</td>
<td>
	<input type="text" name="ack" id="ackstring">
	<input type="submit" value="Send" onclick="sendAck(+byId('ackstring').value);return false">
</td>
</tr>
</table>

<div id="log"></div>

<div id="appswf"></div>

<script>
{{ expandScript("""
goog.require('goog.debug.DivConsole');
goog.require('goog.debug.Logger');
goog.require('goog.async.Deferred');
goog.require('goog.json.Serializer');
goog.require('swfobject');
goog.require('cw.net.FrameType');
goog.require('cw.net.FlashSocket');
goog.require('cw.net.HelloProperty');
goog.require('cw.whoami');
""") }}
</script>

<script>
var logDiv = document.getElementById('log');
var divConsole = new goog.debug.DivConsole(logDiv);
divConsole.setCapturing(true);

var logger = goog.debug.Logger.getLogger('logger');
logger.setLevel(goog.debug.Logger.Level.ALL);

logger.info('Logger works.');

var serializer = new goog.json.Serializer();

function ser(data) {
	return serializer.serialize(data);
}

function getRandom() {
	return goog.string.getRandomString() + goog.string.getRandomString();
}

var flashKey = goog.string.getRandomString();

function loadSWF() {
	var flashvars = {'onloadcallback': '_appswfLoaded', 'flashkey': flashKey};
	var params = {};
	swfobject.embedSWF("app.swf", "appswf", "30", "30", [9, 0, 0], "expressInstall.swf", flashvars, params); // no attributes
}

function _appswfLoaded() {
	connect(document.getElementById('appswf'));
}

var transportCount = -1;
var streamId = getRandom();

var lastFs = null;

function connect(bridge) {
	logger.warning('Connecting.');
	var fs = new cw.net.FlashSocket(bridge);
	var websiteHostPort = (''+document.location.host).split(':');
	var host = websiteHostPort[0];
	var port = 843;

	fs.onconnect = function() {
		try {
			logger.info('onconnect');

			var uaId = cw.whoami.getUaId();
			var transportNumber = ++transportCount;
			// TODO: use constant names instead of these single-letter strings
			var hp = cw.net.HelloProperty;
			var helloData = {};
			helloData[hp.transportNumber] = transportNumber;
			helloData[hp.protocolVersion] = 2;
			helloData[hp.requestNewStream] = transportNumber == 0 ? 1 : 0;
			helloData[hp.streamId] = streamId;
			helloData[hp.credentialsData] = {'uaId': uaId, 'csrf': window.CSRF_TOKEN};
			helloData[hp.streamingResponse] = 1;
			helloData[hp.maxReceiveBytes] = 9999999;
			helloData[hp.maxOpenTime] = 3600;
			helloData[hp.succeedsTransport] = null;
			var helloFrame = ser(helloData) + 'H';
			// If the server receives this more than once, it is
			// subsequently ignored because the box # is always 0,
			// and box 0 was already received.
			var seqNumFrame = '0' + 'N'; // not really necessary to send
			var boxFrame = 'send_demo' + ' ';

			var frames = [helloFrame, seqNumFrame, boxFrame];
			for(i=0; i < frames.length; i++) {
				logger.info('Sending: ' + frames[i]);
			}
			var out = fs.writeSerializedFrames_(frames);
			logger.info('writeSerializedFrames_ rvalue: ' + out);
		} catch(e) {
			logger.severe('error in onconnect', e);
		}
	}

	fs.onclose = function() {
		logger.info('onclose');
		this.dispose();
	}

	fs.onioerror = function(errorText) {
		logger.severe('onioerror: ' + errorText);
		this.dispose();
	}

	fs.onsecurityerror = function(errorText) {
		logger.severe('onsecurityerror: ' + errorText);
		this.dispose();
	}

	fs.onframes = function(frames, hadError, flashKey) {
		logger.info('onframes from '+flashKey+' with '+frames.length+' frame(s). hadError? ' + hadError);
		for(var i=0; i < frames.length; i++) {
			var frame = frames[i]; 
			logger.info('Received: '+ser(frame));
		}
	}

	fs.connect_(host, port);

	lastFs = fs;
}

loadSWF();

function reconnect() {
	logger.warning('Closing.');
	lastFs.close_();
	connect(document.getElementById('appswf'));
}

function sendAck(n) {
	logger.warning('sendAck: ' + n);
	lastFs.writeSerializedFrames_(['|' + String(n) + 'A']);
}

function byId(o) {
	return document.getElementById(o);
}

</script>

</body>
</html>
