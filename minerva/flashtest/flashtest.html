<!doctype html>
<html>
<head>
	<meta http-equiv="charset" content="text/html; charset=utf-8">
	<title></title>
	<style>
		{{ getTestPageCSS() }}
	</style>
	<script>
		{{ expandScript('// import cw.autoTitle') }}
		window.CLOSURE_NO_DEPS = true;
		window.CSRF_TOKEN = {{ dumps(token) }};
	</script>
</head>
<body>

<div id="doc">
</div>

<div>
<a href="#" onclick="reconnect()">Disconnect and connect new transport</a>
</div>

<div id="log"></div>

<div id="appswf"></div>

<script>
{{ expandScript("""
goog.require('goog.debug.DivConsole');
goog.require('goog.debug.Logger');
goog.require('goog.async.Deferred');
goog.require('goog.json.Serializer');
goog.require('swfobject');
goog.require('cw.net.FlashSocket');
goog.require('cw.whoami');
""") }}
</script>

<script>
var logDiv = document.getElementById('log');
var divConsole = new goog.debug.DivConsole(logDiv);
divConsole.setCapturing(true);

var logger = goog.debug.Logger.getLogger('logger');
logger.setLevel(goog.debug.Logger.Level.ALL);

logger.info('Logger works.');

var serializer = new goog.json.Serializer();

function ser(data) {
	return serializer.serialize(data);
}

function loadSWF() {
	var flashvars = {'onloadcallback': '_appswfLoaded'};
	var params = {};
	swfobject.embedSWF("app.swf", "appswf", "30", "30", [9, 0, 0], "expressInstall.swf", flashvars, params); // no attributes
}

function _appswfLoaded() {
	connect(document.getElementById('appswf'));
}

var transportCount = -1;
var streamId = goog.string.getRandomString() + goog.string.getRandomString();

var lastFs = null;

function connect(bridge) {
	logger.warning('Connecting.');
	var fs = new cw.net.FlashSocket(bridge);
	var websiteHostPort = (''+document.location.host).split(':');
	var host = websiteHostPort[0];
	var port = 843;

	fs.onconnect = function() {
		try {
			logger.info('onconnect');

			var uaId = cw.whoami.getUaId();
			var transportNumber = ++transportCount;
			var helloData = {
				'n': transportNumber, 'v': 2, 'w': transportNumber == 0 ? true : false, 'i': streamId,
				'c': {'uaId': uaId, 'csrf': window.CSRF_TOKEN},
				'r': 9999999, 'm': 3600};
			var helloFrame = [5, helloData];
			var gimmeFrame = [6, null];
			// If the server receives this more than once, it is subsequently ignored because the box # is always 0, and box 0 was already received. 
			var boxesFrame = [0, {"0": ['send_demo']}];

			var out = fs.writeSerializedFrames_([ser(helloFrame), ser(gimmeFrame), ser(boxesFrame)]);
			logger.info('writeSerializedFrames_ rvalue: ' + out);
		} catch(e) {
			logger.severe('error in onconnect', e);
		}
	}

	fs.onclose = function() {
		logger.info('onclose');
		this.dispose();
	}

	fs.onioerror = function(errorText) {
		logger.severe('onioerror: ' + errorText);
		this.dispose();
	}

	fs.onsecurityerror = function(errorText) {
		logger.severe('onsecurityerror: ' + errorText);
		this.dispose();
	}

	fs.onframes = function(frames, hadError) {
		logger.info('onframes with '+frames.length+' frame(s). hadError? ' + hadError);
		for(var i=0; i < frames.length; i++) {
			var frame = frames[i]; 
			logger.info('frame: '+ser(frame));
		}
	}

	fs.connect_(host, port);

	lastFs = fs;
}

loadSWF();

function reconnect() {
	logger.warning('Closing.');
	lastFs.close_();
	connect(document.getElementById('appswf'));
}

</script>

</body>
</html>
