<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Tutorial: Making a chat application with Minerva and Closure Library | Minerva Comet server and client</title>
</head>
<body>
<link rel="stylesheet" href="../shared.css" type="text/css">
<style>
h3 {
	margin-top: 2em;
}
code {
	background-color: #e8e7e7;
}
code.shell {
	border: 1px solid #d6d5d5;
	display: block;
	background-color: #e8e7e7;
	padding: 0.5em;
	white-space: nowrap;
	overflow-x: auto;
}
.substep {
	margin-left: 2em;
	margin-bottom: 1.5em;
}
.jsproblem, .important {
	color: darkred;
}
/* hide all non-debuntu OS instructions by default, since the user might not have JS enabled */
.windows {
	display: none;
}
</style>
<div id="content">
<h1><a href="../"><img src="../logo-176x100.png" id="logo" alt="Minerva" height=100></a></h1>
<p>
<a href="../">Â« Minerva home</a> &bull; <a href="./">Tutorials</a>
</p>

<h2>Tutorial: Make a chat application with Minerva and Closure Library</h2>

<p>This tutorial will guide you through making a simple chat application that uses <a href="../">Minerva</a> to communicate between the browser and the server.  We'll install Minerva and Closure Library, then write a chat server (in Python) and chat client (in JavaScript).  If at any point you get stuck for any reason, please tell <a href="mailto:ivan@ludios.org?subject=Suggestion+for+Minerva+with+Closure+tutorial">Ivan</a> so he can improve the tutorial.</p>

<p>If you don't want to use <a href="https://code.google.com/closure/library/">Closure Library</a>, read the <a href="../standalone.html">standalone Minerva tutorial</a> instead.</p>

<noscript><b class="jsproblem">Sorry, JavaScript is required to switch away from the Debian/Ubuntu instructions.</b><br></noscript>
<b><span class="important">Important!</span> Show instructions for:</b><br>
<form>
	<input type="radio" name="os" value="debuntu" id="os-debuntu" onclick="clickedSwitch();return true" checked>
		<label for="os-debuntu">Debian/Ubuntu</label>
	<input type="radio" name="os" value="windows" id="os-windows" onclick="clickedSwitch();return true">
		<label for="os-windows">Windows</label>
</form>
<p>
(This setting changes the entire document.)
</p>

<h3 id="h-contents">Contents</h3>

<noscript><b class="jsproblem">Sorry, JavaScript is required to see this Table of Contents.</b><br></noscript>
<div id="toc"></div>

<h3 id="h-install-python-twisted">Install Python and Twisted</h3>

The Minerva server uses Python and <a href="http://twistedmatrix.com/">Twisted</a>, so you'll need both to write your application server.

<p class="debuntu">You already have Python.  You just need <a href="http://twistedmatrix.com/">Twisted</a>:<br><br>

<code class="shell">
sudo apt-get install python-twisted
</code>

<p class="windows">
Unless you already have a 32-bit Python 2.5+, install the latest 32-bit <a href="http://www.python.org/download/releases/">Python 2.x release</a> (<a href="http://www.python.org/ftp/python/2.7.2/python-2.7.2.msi">direct link to 32-bit Python 2.7.2 MSI installer</a>).  Avoid the 64-bit Python unless you know how to install Twisted on it and <a href="http://twistedmatrix.com/trac/ticket/4669">don't need iocpreactor</a>.
</p>

<p class="windows">
Install the <a href="http://twistedmatrix.com/trac/wiki/Downloads">latest version of Twisted for your Python version</a>.  Try the MSI installer first.  Note that Twisted won't work until you install zope.interface (described below).
</p>

<p class="windows">
Install the <a href="http://sourceforge.net/projects/pywin32/files/pywin32/">latest pywin32 for your Python version</a> (<a href="http://sourceforge.net/projects/pywin32/files/pywin32/Build216/pywin32-216.win32-py2.7.exe/download">direct link to pywin32 216 for 32-bit Python 2.7</a>).  This is required for some Twisted functionality including process-spawning, the IOCP reactor, and colored <a href="http://twistedmatrix.com/trac/wiki/TwistedTrial">trial</a> output.
</p>

<p class="windows">
Install the <a href="http://pypi.python.org/pypi/pyOpenSSL">latest version of pyOpenSSL for your Python version</a>.  Try the MSI installer first.  pyOpenSSL is an optional Twisted dependency that allows you to write SSL clients and servers.
</p>

<h3 id="h-install-pip">Install pip <span class="windows">and zope.interface</span></h3>

<p>
<a href="http://www.pip-installer.org/">pip</a> is the package manager you'll (probably) use to install <span class="windows">zope.interface, Minerva,</span><span class="debuntu">Minerva and</span> and all of Minerva's dependencies.  pip provides a way to uninstall and correctly upgrade a package, which Python's distutils-only <code>setup.py install</code> approach can't do.  Note that the instructions that follow assume that the related <a href="http://www.virtualenv.org/">virtualenv</a> is <strong>not</strong> used.
</p>

<div class="windows">
<p>
pip requires setuptools or distribute (a fork of setuptools).  If you don't already have either, install distribute:
</p>

<div class="substep">
	<p>
	Save a copy of <a href="http://python-distribute.org/distribute_setup.py">http://python-distribute.org/distribute_setup.py</a>.  Open a <code><a href="http://physiology.med.unc.edu/wwwMHMF/how-to/work-with-cmd/default.html">cmd</a></code>, <code>cd</code> to the download directory, and run it with Python:
	</p>

	<code class="shell">
	C:\Python27\python distribute_setup.py
	</code>
</div>

<p>
Now, install pip:
</p>

<div class="substep">
	<p>
	Save a copy of <a href="https://raw.github.com/pypa/pip/master/contrib/get-pip.py">https://raw.github.com/pypa/pip/master/contrib/get-pip.py</a>.  Run it with Python:
	</p>

	<code class="shell">
	C:\Python27\python get-pip.py
	</code>

	<p>
	(If you saved it in Chrome, that might be <code>get-pip.py.txt</code>)
	</p>
	</div>

<p>
Now, let's install zope.interface with pip:
</p>

<div class="substep">
	<code class="shell">
	C:\Python27\Scripts\pip install zope.interface
	</code>

	<p>
	Ignore this warning:<br>
	<code>An optional code optimization (C extension) could not be compiled.</code>.
	</p>
</div>

<p>
Of course, you can use pip to install almost any Python package.
</p>

<p>
Side note: if you don't want to type out <code>C:\Python27</code> and <code>C:\Python27\Scripts</code> every time, you can add both directories to your User or System <code>Path</code> variable (<a href="http://www.computerhope.com/issues/ch000549.htm">instructions for XP</a> or <a href="http://msdn.microsoft.com/en-us/library/ee537574.aspx">Windows 7</a>).  Then you'll be able to type just <code>python</code> or <code>pip</code>.  (Note: reopen the <code>cmd</code> window for <code>Path</code> changes to take effect.)
</p>
</div>

<div class="debuntu">
<p>
Run:
</p>

<code class="shell">
sudo apt-get install python-pip
</code>

<p>
or on an older distribution:
</p>

<code class="shell">
sudo apt-get install pip
</code>
</div>

<h3 id="h-install-minerva">Install Minerva and its dependencies</h3>

<p>The simplest way to install Minerva and its dependencies is:</p>

<code class="shell debuntu">
pip install --user Minerva
</code>

<code class="shell windows">
C:\Python27\Scripts\pip install Minerva
</code>

<p>
The above will install <a href="https://github.com/ludios/Minerva">Minerva</a> and its dependencies <a href="https://github.com/ludios/Coreweb">Coreweb</a>, <a href="https://github.com/ludios/Webmagic">Webmagic</a>, <a href="https://github.com/ludios/Securetypes">Securetypes</a>, <a href="https://github.com/ludios/Strfrag">Strfrag</a>, <a href="http://pypi.python.org/pypi/Jinja2">jinja2</a>, and <a href="http://pypi.python.org/pypi/simplejson">simplejson</a>.
</p>

<p class="debuntu">
<code>--user</code> installs everything to your <code>~/.local/lib/</code> rather than the system-wide Python root.
</p>

<p>
Alternative route: if you prefer not to have pip download packages, or want the very latest code, you can use <code>git</code> and <code>pip install .</code>:
</p>

<div class="substep">
	<code class="shell">
	git clone https://github.com/ludios/Minerva<br>
	git clone https://github.com/ludios/Coreweb<br>
	git clone https://github.com/ludios/Webmagic<br>
	git clone https://github.com/ludios/Securetypes<br>
	git clone https://github.com/ludios/Strfrag<br>
	<br>
	git clone https://github.com/mitsuhiko/jinja2<br>
	git clone https://github.com/simplejson/simplejson<br> <!-- TODO: make user install binary package with speedups!  Perhaps make Minerva use json instead of simplejson when available? -->
	</code>

	<p>
	Then, <code>cd</code> into each directory and run:
	</p>

	<code class="shell debuntu">
	pip install --user --no-deps --ignore-installed .
	</code>

	<code class="shell windows">
	C:\Python27\Scripts\pip install --no-deps --ignore-installed .
	</code>

	<p>(note the trailing <code>.</code>).</p>
</div>

<h3 id="h-install-closure">Install Closure Library</h3>

<p>
The Minerva client uses <a href="https://code.google.com/closure/library/">Closure Library</a>, so you'll need a copy.  Google doesn't do regular releases of it, so you'll want to get a copy of <a href="https://code.google.com/p/closure-library/source/list">trunk</a> (it's kept stable).
</p>

<div class="debuntu">
<p>If you don't already have Subversion, install it:</p>

<code class="shell">
sudo apt-get install subversion
</code>
</div>

<div class="windows">
<p>If you don't already have Subversion, download and install <a href="http://www.sliksvn.com/en/download">Slik SVN</a>.  The installer will put a command-line <code>svn</code> in your <code>Path</code>.</p>
</div>

<p>
From now on, you'll be working in some kind of <code>Projects</code> directory that you can put anywhere.  The rest of this documentation will assumes that it's called <code>Projects</code> and in your home directory, so substitute paths if that's not the case.
</p>

<p>Make a <code>Projects</code> directory if you don't already have one:</p>

<code class="shell debuntu">
mkdir ~/Projects<br>
cd ~/Projects
</code>

<div class="windows">
<code class="shell">
cd /d "%USERPROFILE%"<br>
mkdir Projects<br>
cd Projects
</code>

<p>
(Tip: <code>/d</code> means switch drive letter if necessary.)
</p>
</div>

<p>Now, inside <code>Projects</code>, check out Closure Library:</p>

<code class="shell">
svn checkout https://closure-library.googlecode.com/svn/trunk/ closure-library
</code>

<p>
Alternative route: if you prefer to have the full version history of Closure Library, you can use <code>git svn</code> to do the checkout (this will take much longer):
</p>
<div class="substep">
	<code class="shell">
	git svn clone --stdlayout https://closure-library.googlecode.com/svn closure-library
	</code>
	<p class="windows">
	(This requires <a href="https://code.google.com/p/msysgit/">msysgit</a>.  When installing, select "Run Git from the Windows Command Prompt" and "Checkout as-is, commit as-is".)
	</p>
</div>

<h3 id="h-run-server-tests">Running the server-side unit tests</h3>

<p>
By now, you have everything you need to start working with Minerva.  But before you do so, run the unit tests to make sure that Minerva works properly on your system.  To do this, we use Twisted's test runner, <a href="http://twistedmatrix.com/trac/wiki/TwistedTrial">trial</a>.  If you have Twisted installed, you already have trial.
</p>

<p>
Run the unit tests for Minerva, Webmagic, Securetypes, and Strfrag:
</p>

<code class="shell debuntu">
trial minerva webmagic test_securetypes test_strfrag
</code>

<div class="windows">
<code class="shell windows">
C:\Python27\python C:\Python27\Scripts\trial.py minerva webmagic test_securetypes test_strfrag
</code>
</div>

<p>
The tests should take a few seconds to run.  Make sure the very last line of the output says <code style="color:darkgreen; font-weight: bold">PASSED</code>.  Note that it's okay to see tracebacks for tests marked <code>[TODO]</code>.
</p>

<p>
If any of the tests failed, Minerva may still work, but please report a bug for <a href="https://github.com/ludios/Minerva/issues">Minerva</a>, <a href="https://github.com/ludios/Webmagic/issues">Webmagic</a>, <a href="https://github.com/ludios/Securetypes/issues">Securetypes</a>, or <a href="https://github.com/ludios/Strfrag/issues">Strfrag</a>.  Any test failure, hang, or crash is a bug.
</p>

<h3 id="h-run-client-tests">Running the client-side unit tests</h3>

<p>Minerva also comes with client-side unit tests.  These tests run in a browser, rather than in the command line.  To run these tests, you'll first need to start the <code>minerva_site</code> server installed by Minerva.</p>

<p>
To start <code>minerva_site</code>'s HTTP server, run:
</p>

<code class="shell debuntu">
cd /tmp<br>
twistd -n minerva_site -t tcp:8111:interface=127.0.0.1 -m tcp:8430:interface=127.0.0.1 "--closure-library=$HOME/Projects/closure-library"
</code>

<code class="shell windows">
cd /d "%TEMP%"<br>
C:\Python27\python C:\Python27\Scripts\twistd.py -n minerva_site -t tcp:8111:interface=127.0.0.1 -m tcp:8430:interface=127.0.0.1 "--closure-library=%USERPROFILE%\Projects\closure-library"
</code>

<p>
You should now be able to reach the server at <a href="http://127.0.0.1:8111/">http://127.0.0.1:8111/</a>.  Note that the above command also starts a non-HTTP socket listener on port 8430.  This is used by Minerva's optional Flash socket transport.  You may use any port numbers you want.  Run <code><span class="windows">C:\Python27\python C:\Python27\Scripts\twistd.py</span><span class="debuntu">twistd</span> -n minerva_site --help</code> for more <code>minerva_site</code> help.
</p>

<p>
The first <code>cd</code> step above is optional; do it to avoid creating some files (twistd.log, twistd.pid) in a directory that needs to stay unchanged.  (And what's <code>twistd</code>, you ask?  It's Twisted's tool for starting up daemons.  But in this case, we use <code>-n</code> to stay in the foreground rather than daemonize.)
</p>

<p>
With the server running, you can run the client-side tests by navigating to:
</p>

<p>
<a href="http://127.0.0.1:8111/js_minerva_tests.html">http://127.0.0.1:8111/js_minerva_tests.html</a></p>

<p>After a few seconds, you'll see a box in the top-right corner indicating test suite success (green) or failure (red). If you see any failures, please report a bug on <a href="https://github.com/ludios/Minerva/issues">Minerva</a>.</p>

<p>Is your test runner stuck or failing after a delay?  It's probably because some tests use a Flash object (when the Flash plugin is available, at least).  Chrome users who block plugins may have to allow plugins for this domain (click the plugin icon in the URL bar).  <a href="http://noscript.net/">NoScript</a> users may have to click on the Flash object at the bottom of the page.
</p>

<p>
</p>

<script src="../jquery-1.6.4.min.js"></script>
<script src="../samaxesjs.toc-1.3.3.min.js"></script>
<script>
var allOS = ["debuntu", "windows"];

function switchInstructions(os) {
	$('.' + os).show();
	$.each(allOS, function(i, otherOS) {
		if(os != otherOS) {
			$('.' + otherOS).hide();
		}
	});
}

function getOS() {
	if($('#os-debuntu').prop('checked')) {
		return "debuntu";
	}
	return "windows";
}

function clickedSwitch() {
	switchInstructions(getOS());
}

$(document).ready(function() {
	clickedSwitch();
	samaxesJS.toc({exclude: 'h1, h2'});
});

</script>

</body>
</html>
